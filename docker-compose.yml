version: '3.8'

services:
  # --- THE BRAIN (Python/Flask + AI Tools) ---
  devquest_generator:
    build: .
    container_name: devquest_generator
    restart: always
    # OVERRIDE: Run the web server instead of the generator script
    command: python server.py
    volumes:
      # Maps your local folder to /app so changes to academy.db are instant
      - .:/app
    ports:
      # Expose Flask port
      - "5000:5000"
    environment:
      - OLLAMA_HOST=http://host.docker.internal:11434
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - career_network

  # --- THE BRIDGE (Secure Tunnel) ---
  cloudflare_tunnel:
    image: cloudflare/cloudflared:latest
    container_name: academy_tunnel
    restart: always
    # Use the token you just provided
    environment:
      - TUNNEL_TOKEN=eyJhIjoiODUyYWQwMGU2ZTFkZjEyYjQ3NGZkNTQxYjBmMTNlZDEiLCJ0IjoiNjliMzM5NTQtODJmNi00YjY1LTgxMTktYzRlYzA3YmIwZmIyIiwicyI6Ik56TTVZVE14WkRJdFlqQXdZaTAwTmpRMkxXSmxaRE10TWpsaVlXSmxZbVJoT1RCayJ9
    command: tunnel --no-autoupdate run
    networks:
      - career_network

  # --- OPTIONAL TOOLS ---
  wetty_terminal:
    image: wettyoss/wetty
    container_name: wetty_terminal
    restart: always
    ports:
      - "3000:3000"
    environment:
      - WETTY_COMMAND=ssh -o StrictHostKeyChecking=no root@lab_target
    depends_on:
      - lab_target
    networks:
      - career_network

  lab_target:
    image: ubuntu:22.04
    container_name: lab_target
    restart: always
    tty: true
    stdin_open: true
    command: >
      sh -c "apt-get update && apt-get install -y openssh-server python3 &&
             mkdir -p /var/run/sshd &&
             echo 'root:root' | chpasswd &&
             sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config &&
             /usr/sbin/sshd -D"
    networks:
      - career_network

networks:
  career_network:
    driver: bridge