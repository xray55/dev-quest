<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DEV//QUEST Academy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Literata:ital,wght@0,400;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

    <style>
        :root {
            /* Sophisticated dark theme optimized for learning */
            --bg-deep: #0d0d0f;
            --bg-primary: #16161a;
            --bg-secondary: #1e1e24;
            --bg-elevated: #26262e;
            --bg-code: #1a1a20;
            
            --text-primary: #e8e8ec;
            --text-secondary: #b8b8c0;
            --text-tertiary: #7d7d88;
            
            --accent: #ff6b35;
            --accent-soft: #ff8c5f;
            --accent-dim: #4a2618;
            --accent-glow: rgba(255, 107, 53, 0.2);
            
            --success: #00d9a3;
            --success-dim: #00473a;
            --warning: #ffa726;
            --danger: #ff5252;
            --info: #42a5f5;
            
            --border: #2a2a32;
            --border-light: #38383f;
            
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-strong: rgba(0, 0, 0, 0.6);
            
            --highlight: rgba(255, 107, 53, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Literata', Georgia, serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            line-height: 1.7;
            overflow: hidden;
        }

        /* ========== LOADING SCREEN ========== */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-deep);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.6s ease, visibility 0.6s;
        }
        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .loading-logo {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, var(--accent), var(--accent-soft));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 24px;
            color: var(--bg-deep);
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 8px 24px var(--accent-glow);
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }
        
        .ai-status-pill {
            margin-top: 12px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ai-status-pill .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        /* ========== LAYOUT ========== */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ========== SIDEBAR ========== */
        .sidebar {
            width: 320px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .ai-generation-banner {
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--info), #5e35b1);
            border-bottom: 1px solid var(--border);
            display: none;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: white;
        }
        .ai-generation-banner.visible {
            display: flex;
        }
        .ai-generation-banner .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .ai-generation-banner .text {
            flex: 1;
        }
        .ai-generation-banner .count {
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        /* ========== CAREER PATH SELECTOR ========== */
        .path-selector {
            padding: 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .path-selector-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-tertiary);
            margin-bottom: 10px;
        }

        #career-path-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Literata', Georgia, serif;
        }

        #career-path-select:hover {
            border-color: var(--accent);
        }

        #career-path-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .path-info {
            margin-top: 10px;
            padding: 12px;
            background: var(--accent-dim);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-secondary);
            display: none;
        }

        .path-info.visible {
            display: block;
        }

        .path-info-desc {
            margin-bottom: 8px;
        }

        .path-info-salary {
            color: var(--success);
            font-weight: 600;
            font-family: 'Space Mono', monospace;
        }

        /* ========== SEARCH ========== */
        .search-container {
            padding: 12px 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-container i.fa-search {
            color: var(--text-tertiary);
            font-size: 14px;
        }

        #lesson-search {
            flex: 1;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        #lesson-search:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        #lesson-search::placeholder {
            color: var(--text-tertiary);
        }

        .search-clear {
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
            display: none;
        }

        .search-clear.visible {
            display: block;
        }

        .search-clear:hover {
            color: var(--accent);
        }

        /* ========== SKILL TREE PROGRESS ========== */
        .skill-tree-section {
            padding: 12px 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            max-height: 280px;
            overflow-y: auto;
        }

        .skill-tree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            user-select: none;
        }
        
        .skill-tree-header:hover .skill-tree-label {
            color: var(--accent-soft);
        }

        .skill-tree-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }

        .skill-tree-stats {
            font-size: 11px;
            color: var(--text-tertiary);
            font-family: 'Space Mono', monospace;
        }

        .skill-tree-body {
            display: block;
        }
        
        .skill-tree-body.collapsed {
            display: none;
        }

        .skill-tree-visual {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .skill-tree-track {
            margin-bottom: 6px;
        }

        .skill-tree-track:last-child {
            margin-bottom: 0;
        }

        .skill-tree-track-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .skill-tree-track-name {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .skill-tree-track-progress {
            font-size: 9px;
            color: var(--text-tertiary);
            font-family: 'Space Mono', monospace;
        }

        .skill-tree-track-bar {
            height: 4px;
            background: var(--bg-code);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .skill-tree-track-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-soft));
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .overall-progress-bar {
            height: 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .overall-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #00b386);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .overall-progress-text {
            font-size: 11px;
            color: var(--text-tertiary);
            text-align: center;
            margin-bottom: 8px;
        }

        /* ========== LESSON LIST ========== */
        .lesson-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .lesson-track {
            margin-bottom: 16px;
        }

        .lesson-track.hidden {
            display: none;
        }

        .track-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .track-header:hover {
            background: var(--bg-elevated);
            border-color: var(--accent);
        }

        .track-title-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .track-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }

        .track-progress-badge {
            background: var(--accent-dim);
            color: var(--accent-soft);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        .track-icon {
            color: var(--text-tertiary);
            transition: transform 0.2s;
        }

        .track-header.expanded .track-icon {
            transform: rotate(180deg);
        }

        .lesson-items {
            display: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 4px;
        }

        .lesson-items.expanded {
            display: block;
        }

        .lesson-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-primary);
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .lesson-item:last-child {
            margin-bottom: 0;
        }

        .lesson-item:hover {
            background: var(--bg-elevated);
            transform: translateX(4px);
        }

        .lesson-item.active {
            background: var(--accent-dim);
            border-left: 3px solid var(--accent);
        }

        .lesson-item.viewed {
            opacity: 0.7;
        }

        .lesson-item.hidden {
            display: none;
        }

        .lesson-item.search-highlight {
            background: var(--highlight);
            border-left: 3px solid var(--accent);
        }

        .lesson-item.generating {
            opacity: 0.6;
            pointer-events: none;
        }

        .lesson-item.generating .lesson-icon {
            animation: pulse 1.5s ease-in-out infinite;
        }

        .lesson-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background: var(--bg-elevated);
            color: var(--text-tertiary);
            flex-shrink: 0;
        }

        .lesson-item.viewed .lesson-icon {
            background: var(--success-dim);
            color: var(--success);
        }

        .lesson-details {
            flex: 1;
            min-width: 0;
        }

        .lesson-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lesson-meta {
            font-size: 11px;
            color: var(--text-tertiary);
            display: flex;
            gap: 8px;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .no-results i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .no-results p {
            font-size: 14px;
        }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px 32px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--accent-soft));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 18px;
            color: var(--bg-deep);
        }

        .logo-text {
            font-family: 'Space Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .debug-btn {
            padding: 8px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .debug-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .help-btn {
            padding: 8px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .help-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .content-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .lesson-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .lesson-header {
            padding: 24px 32px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
        }

        .lesson-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .lesson-meta-bar {
            display: flex;
            gap: 16px;
            color: var(--text-tertiary);
            font-size: 13px;
        }

        .lesson-meta-bar span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .analogy-section {
            padding: 20px 32px;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.05), rgba(255, 140, 95, 0.05));
            border-bottom: 1px solid var(--border);
            border-left: 4px solid var(--accent);
        }

        .analogy-section .icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .analogy-section h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-soft);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .analogy-section p {
            font-size: 15px;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .lesson-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .markdown-content {
            max-width: 800px;
        }

        .markdown-content h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            line-height: 1.3;
        }

        .markdown-content h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 32px 0 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .markdown-content h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 24px 0 12px;
        }

        .markdown-content p {
            margin-bottom: 16px;
            color: var(--text-secondary);
            font-size: 16px;
        }

        .markdown-content ul, .markdown-content ol {
            margin-bottom: 16px;
            padding-left: 24px;
        }

        .markdown-content li {
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .markdown-content code {
            background: var(--bg-code);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: var(--accent-soft);
        }

        .markdown-content pre {
            background: var(--bg-code);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
            font-size: 14px;
            color: var(--text-primary);
        }

        .markdown-content blockquote {
            border-left: 4px solid var(--accent);
            padding-left: 16px;
            margin: 20px 0;
            color: var(--text-tertiary);
            font-style: italic;
        }

        .markdown-content a {
            color: var(--accent-soft);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }

        .markdown-content a:hover {
            border-bottom-color: var(--accent-soft);
        }

        /* ========== IDE PANEL ========== */
        .ide-panel {
            width: 45%;
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .ide-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .ide-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ide-actions {
            display: flex;
            gap: 8px;
        }

        .ide-btn {
            padding: 6px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'JetBrains Mono', monospace;
        }

        .ide-btn:hover {
            background: var(--bg-primary);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .ide-btn.run {
            background: linear-gradient(135deg, var(--accent), var(--accent-soft));
            color: var(--bg-deep);
            border: none;
            font-weight: 600;
        }

        .ide-btn.run:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .code-editor {
            flex: 1;
            position: relative;
        }

        #editor {
            width: 100%;
            height: 100%;
            font-size: 14px;
        }

        .console-output {
            height: 200px;
            background: var(--bg-code);
            border-top: 1px solid var(--border);
            padding: 16px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        /* ========== NAVIGATION FOOTER ========== */
        .nav-footer {
            padding: 16px 32px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-btn {
            padding: 10px 20px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Literata', Georgia, serif;
        }

        .nav-btn:hover:not(:disabled) {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .lesson-position {
            font-size: 13px;
            color: var(--text-tertiary);
            font-family: 'Space Mono', monospace;
        }

        /* ========== TOAST ========== */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px var(--shadow-strong);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(120px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--success), #00b386);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .toast-content {
            flex: 1;
        }

        .toast-message {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Debug Modal */
        .debug-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        .debug-modal.visible {
            display: flex;
        }

        .debug-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .debug-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debug-header h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .debug-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .debug-close:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .debug-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .debug-status-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .debug-status-item .time {
            color: var(--text-tertiary);
            font-size: 11px;
        }

        .debug-status-item .message {
            color: var(--text-secondary);
        }

        .debug-refresh {
            margin-top: 16px;
            padding: 10px 20px;
            background: var(--accent);
            color: var(--bg-deep);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }

        .debug-refresh:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .ide-panel {
                width: 50%;
            }
        }

        @media (max-width: 900px) {
            .content-wrapper {
                flex-direction: column;
            }
            .ide-panel {
                width: 100%;
                height: 50%;
                border-left: none;
                border-top: 1px solid var(--border);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 300px;
                position: absolute;
                left: -100%;
                top: 0;
                bottom: 0;
                z-index: 100;
                transition: left 0.3s;
            }
            .sidebar.open {
                left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen">
        <div class="loading-logo">DQ</div>
        <div class="loading-text">Initializing DEV//QUEST Academy...</div>
        <div class="ai-status-pill">
            <div class="pulse-dot"></div>
            <span>AI Engine Starting</span>
        </div>
    </div>

    <div class="debug-modal" id="debug-modal">
        <div class="debug-content">
            <div class="debug-header">
                <h2><i class="fa-solid fa-bug"></i> AI Generation Status</h2>
                <button class="debug-close" onclick="closeDebugModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="debug-body" id="debug-body">
                <div class="debug-status-item">
                    <span class="message">Loading AI status...</span>
                </div>
                <button class="debug-refresh" onclick="loadDebugInfo()">
                    <i class="fa-solid fa-refresh"></i> Refresh Status
                </button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <div class="toast-icon">
            <i class="fa-solid fa-check"></i>
        </div>
        <div class="toast-content">
            <div class="toast-message" id="toast-message">Progress saved!</div>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar">
            <div class="ai-generation-banner" id="ai-banner">
                <div class="spinner"></div>
                <div class="text">
                    AI generating lessons...
                    <div class="count" id="ai-progress">0 / 0</div>
                </div>
            </div>

            <div class="path-selector">
                <div class="path-selector-header">
                    <i class="fa-solid fa-compass"></i>
                    <span>Your Career Path</span>
                </div>
                <select id="career-path-select">
                    <option value="all">All Tracks</option>
                    <optgroup label="Software Development">
                        <option value="fullstack">Full-Stack Developer</option>
                        <option value="backend">Backend Engineer</option>
                        <option value="frontend">Frontend Developer</option>
                        <option value="mobile">Mobile Developer</option>
                    </optgroup>
                    <optgroup label="Cloud & Infrastructure">
                        <option value="devops">DevOps Engineer</option>
                        <option value="cloud">Cloud Architect</option>
                        <option value="sre">Site Reliability Engineer</option>
                    </optgroup>
                    <optgroup label="Data & AI">
                        <option value="data">Data Scientist</option>
                        <option value="ml">Machine Learning Engineer</option>
                    </optgroup>
                    <optgroup label="Security">
                        <option value="redteam">Red Team / Pentester</option>
                        <option value="blueteam">Blue Team / SOC Analyst</option>
                        <option value="security">Security Engineer (Full)</option>
                    </optgroup>
                </select>
                <div class="path-info" id="path-info">
                    <div class="path-info-desc"></div>
                    <div class="path-info-salary"></div>
                </div>
            </div>

            <div class="search-container">
                <i class="fa-solid fa-search"></i>
                <input type="text" id="lesson-search" placeholder="Search lessons...">
                <button class="search-clear" id="search-clear">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="skill-tree-section">
                <div class="skill-tree-header" onclick="toggleSkillTree()">
                    <div class="skill-tree-label">
                        <i class="fa-solid fa-diagram-project"></i>
                        <span>Learning Progress</span>
                        <i class="fa-solid fa-chevron-down" id="skill-tree-icon" style="font-size: 10px; transition: transform 0.2s;"></i>
                    </div>
                    <div class="skill-tree-stats" id="overall-stats">0 / 0</div>
                </div>

                <div class="skill-tree-body" id="skill-tree-body">
                    <div class="overall-progress-bar">
                        <div class="overall-progress-fill" id="overall-progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="overall-progress-text" id="overall-progress-text">Get started by viewing your first lesson</div>

                    <div class="skill-tree-visual" id="skill-tree-tracks">
                        </div>
                </div>
            </div>

            <div class="lesson-list" id="lesson-list">
                </div>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="logo">
                    <div class="logo-icon">DQ</div>
                    <div class="logo-text">DEV//QUEST</div>
                </div>
                <div class="header-actions">
                    <button class="debug-btn" onclick="showDebugModal()">
                        <i class="fa-solid fa-bug"></i>
                        <span>AI Status</span>
                    </button>
                    <button class="help-btn">
                        <i class="fa-solid fa-circle-question"></i>
                    </button>
                </div>
            </div>

            <div class="content-wrapper">
                <div class="lesson-content">
                    <div class="lesson-header">
                        <h1 id="lesson-title">Welcome to DEV//QUEST Academy</h1>
                        <div class="lesson-meta-bar">
                            <span>
                                <i class="fa-regular fa-clock"></i>
                                <span id="lesson-duration">15 min</span>
                            </span>
                            <span>
                                <i class="fa-solid fa-code"></i>
                                <span id="lesson-type">Concept</span>
                            </span>
                        </div>
                    </div>

                    <div class="analogy-section" id="analogy-section" style="display: none;">
                        <div class="icon">ðŸ’¡</div>
                        <h3>Think of it this way...</h3>
                        <p id="analogy-text"></p>
                    </div>

                    <div class="lesson-body">
                        <div class="markdown-content" id="markdown-content">
                            <h1>Welcome to DEV//QUEST Academy ðŸš€</h1>
                            <p>Select a lesson from the sidebar to begin your learning journey. Our AI is generating personalized lessons just for you!</p>
                            <h2>How It Works</h2>
                            <ul>
                                <li>ðŸŽ¯ <strong>Choose Your Path</strong> - Select a career track that interests you</li>
                                <li>ðŸ“š <strong>Learn at Your Pace</strong> - Progress through lessons automatically tracked</li>
                                <li>ðŸ’» <strong>Practice Coding</strong> - Use the live code editor to try examples</li>
                                <li>ðŸ“Š <strong>Track Progress</strong> - See your skill tree grow as you learn</li>
                            </ul>
                            <p>Your progress is automatically saved as you view lessons. No need to manually mark anything complete!</p>
                        </div>
                    </div>
                </div>

                <div class="ide-panel">
                    <div class="ide-toolbar">
                        <div class="ide-title">
                            <i class="fa-solid fa-terminal"></i>
                            Live Code Editor
                        </div>
                        <div class="ide-actions">
                            <button class="ide-btn" onclick="resetCode()">
                                <i class="fa-solid fa-rotate-left"></i> Reset
                            </button>
                            <button class="ide-btn run" onclick="runCode()">
                                <i class="fa-solid fa-play"></i> Run
                            </button>
                        </div>
                    </div>
                    <div class="code-editor">
                        <div id="editor"># Welcome to the live code editor!
# Write your code here and click "Run" to execute it.

print("Hello, DEV//QUEST!")</div>
                    </div>
                    <div class="console-output" id="console">
                        <span style="color: #888">Output will appear here...</span>
                    </div>
                </div>
            </div>

            <div class="nav-footer">
                <button class="nav-btn" id="prev-btn" onclick="prevLesson()" disabled>
                    <i class="fa-solid fa-arrow-left"></i> Previous
                </button>
                <div class="lesson-position" id="lesson-position">
                    Lesson <span id="current-pos">-</span> of <span id="total-pos">-</span>
                </div>
                <button class="nav-btn" id="next-btn" onclick="nextLesson()" disabled>
                    Next <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // API CONFIGURATION
        // ========================================
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? ''
            : 'https://devquest.uk';

        // ========================================
        // STATE
        // ========================================
        let allTracks = [];
        let allLessons = [];
        let currentLesson = null;
        let currentIndex = -1;
        let viewedLessons = [];
        let totalLessons = 0;
        let currentCareerPath = 'all';
        let editor = null;
        let pyodide = null;
        let originalCode = '';
        let aiStatusInterval = null;
        let pendingLessonsCount = 0;
        let trackProgress = {}; // Track-by-track progress

        // ========================================
        // CAREER PATHS
        // ========================================
        const CAREER_PATHS = {
            'all': {
                name: 'All Tracks',
                tracks: [], // Empty array = show everything
                desc: 'Explore all available lessons across every technology and specialization.',
                salary: 'Varied'
            },
            'fullstack': {
                name: 'Full-Stack Developer',
                tracks: ['00. Foundations', '01A. HTML', '01B. CSS', '02A. JavaScript Basics', '02B. JS Data Structures', '02C. JS DOM', '02D. JS Advanced', '03. Git', '05. TypeScript', '06A. React', '06B. React Advanced', '07. Next.js', '08A. Node.js', '08B. SQL', '08C. MongoDB', '08D. API & Auth', '11A. Docker'],
                desc: 'Master both frontend and backend development to build complete web applications.',
                salary: '$85k - $190k'
            },
            'backend': {
                name: 'Backend Engineer',
                tracks: ['00. Foundations', '03. Git', '08A. Node.js', '08B. SQL', '08C. MongoDB', '08D. API & Auth', '09A. Python', '09B. Python Advanced', '10A. Linux', '11A. Docker', '11B. Kubernetes'],
                desc: 'Build robust server-side applications and APIs that power modern software.',
                salary: '$80k - $180k'
            },
            'frontend': {
                name: 'Frontend Developer',
                tracks: ['00. Foundations', '01A. HTML', '01B. CSS', '02A. JavaScript Basics', '02B. JS Data Structures', '02C. JS DOM', '02D. JS Advanced', '03. Git', '05. TypeScript', '06A. React', '06B. React Advanced', '07. Next.js'],
                desc: 'Create beautiful, responsive user interfaces that delight users.',
                salary: '$70k - $160k'
            },
            'mobile': {
                name: 'Mobile Developer',
                tracks: ['00. Foundations', '02A. JavaScript Basics', '02D. JS Advanced', '03. Git', '05. TypeScript', '06A. React', '06B. React Advanced', '12A. Mobile (React Native)'],
                desc: 'Build native mobile applications for iOS and Android.',
                salary: '$90k - $175k'
            },
            'devops': {
                name: 'DevOps Engineer',
                tracks: ['00. Foundations', '03. Git', '09A. Python', '10A. Linux', '11A. Docker', '11B. Kubernetes', '11C. AWS', '11D. Terraform', '11E. CI/CD', '11F. Monitoring', '11G. SRE'],
                desc: 'Automate deployment pipelines and manage cloud infrastructure at scale.',
                salary: '$95k - $200k'
            },
            'data': {
                name: 'Data Scientist',
                tracks: ['00. Foundations', '04A. CS Math', '04B. Data Structures', '04C. Algorithms', '09A. Python', '09B. Python Advanced', '08B. SQL', '13A. Data Science', '13B. ML', '13C. Deep Learning'],
                desc: 'Extract insights from data using statistical analysis and machine learning.',
                salary: '$105k - $165k'
            },
            'ml': {
                name: 'Machine Learning Engineer',
                tracks: ['00. Foundations', '04A. CS Math', '04C. Algorithms', '09A. Python', '09B. Python Advanced', '13A. Data Science', '13B. ML', '13C. Deep Learning', '11A. Docker', '11B. Kubernetes'],
                desc: 'Build and deploy machine learning models at scale.',
                salary: '$120k - $210k'
            },
            'redteam': {
                name: 'Red Team / Penetration Tester',
                tracks: ['00. Foundations', '09A. Python', '10A. Linux', '14A. Red Team', '14B. Web Pentesting', '14C. Network Pentesting', '14D. AD Attacks', '14E. Post-Exploitation'],
                desc: 'Simulate real-world attacks to identify security vulnerabilities.',
                salary: '$110k - $190k'
            },
            'blueteam': {
                name: 'Blue Team / SOC Analyst',
                tracks: ['00. Foundations', '09A. Python', '10A. Linux', '15A. Blue Team', '15B. SIEM', '15C. DFIR', '15D. Threat Intel', '15E. EDR', '15F. NSM', '15G. Malware Analysis', '15H. Threat Hunting'],
                desc: 'Defend systems by detecting, analyzing, and responding to security threats.',
                salary: '$100k - $180k'
            },
            'security': {
                name: 'Security Engineer (Full Spectrum)',
                tracks: ['00. Foundations', '09A. Python', '10A. Linux', '14A. Red Team', '14B. Web Pentesting', '14C. Network Pentesting', '14D. AD Attacks', '15A. Blue Team', '15B. SIEM', '15C. DFIR', '15D. Threat Intel', '15E. EDR', '15F. NSM', '15I. Purple Team'],
                desc: 'Master both offensive and defensive security across the entire security spectrum.',
                salary: '$115k - $200k'
            },
            'cloud': {
                name: 'Cloud Architect',
                tracks: ['00. Foundations', '03. Git', '09A. Python', '10A. Linux', '11A. Docker', '11B. Kubernetes', '11C. AWS', '11D. Terraform', '11E. CI/CD', '11F. Monitoring', '11G. SRE'],
                desc: 'Design and implement scalable cloud infrastructure solutions.',
                salary: '$130k - $220k'
            },
            'sre': {
                name: 'Site Reliability Engineer',
                tracks: ['00. Foundations', '03. Git', '09A. Python', '10A. Linux', '11A. Docker', '11B. Kubernetes', '11C. AWS', '11E. CI/CD', '11F. Monitoring', '11G. SRE'],
                desc: 'Ensure systems are reliable, scalable, and highly available.',
                salary: '$120k - $210k'
            }
        };

        // ========================================
        // INITIALIZATION
        // ========================================
        async function init() {
            console.log('ðŸš€ Initializing DEV//QUEST Academy...');

            // Initialize Ace Editor
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/monokai");
            editor.session.setMode("ace/mode/python");
            editor.setOptions({
                fontSize: "14px",
                showPrintMargin: false,
                enableBasicAutocompletion: true,
                enableLiveAutocompletion: true
            });

            // Load progress
            loadProgress();

            // Load curriculum
            await loadCurriculum();

            // Load saved preferences
            loadSavedPreferences();

            // Initialize Pyodide in background
            initPyodide();

            // Set up event listeners
            setupEventListeners();

            // Start AI status polling
            startAIStatusPolling();

            // Hide loading screen
            setTimeout(() => {
                document.querySelector('.loading-screen').classList.add('hidden');
            }, 1000);
        }

        function setupEventListeners() {
            // Career path selector
            document.getElementById('career-path-select').addEventListener('change', (e) => {
                currentCareerPath = e.target.value;
                localStorage.setItem('devquest_career_path', currentCareerPath);
                filterByCareerPath();
                updatePathInfo();
                updateSkillTree();
            });

            // Search
            const searchInput = document.getElementById('lesson-search');
            const searchClear = document.getElementById('search-clear');

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                searchClear.classList.toggle('visible', query.length > 0);
                filterLessons(query);
            });

            searchClear.addEventListener('click', () => {
                searchInput.value = '';
                searchClear.classList.remove('visible');
                filterLessons('');
            });

            // Update path info on load
            updatePathInfo();
        }

        // ========================================
        // AI STATUS POLLING
        // ========================================
        function startAIStatusPolling() {
            aiStatusInterval = setInterval(checkAIStatus, 5000);
            checkAIStatus();
        }

        async function checkAIStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/ai-status`);
                const logs = await response.json();

                const isGenerating = logs.some(log =>
                    log.message.includes('Generating') ||
                    log.message.includes('Publishing')
                );

                const banner = document.getElementById('ai-banner');
                if (isGenerating) {
                    banner.classList.add('visible');

                    const curriculum = await fetch(`${API_BASE_URL}/curriculum`).then(r => r.json());
                    const allLessonsCount = curriculum.tracks.reduce((sum, track) =>
                        sum + track.lessons.length, 0);

                    const pendingCount = curriculum.tracks.reduce((sum, track) =>
                        sum + track.lessons.filter(l => l.status === 'pending').length, 0);

                    document.getElementById('ai-progress').textContent =
                        `${allLessonsCount - pendingCount} / ${allLessonsCount}`;
                } else {
                    banner.classList.remove('visible');
                }
            } catch (error) {
                console.error('Failed to check AI status:', error);
            }
        }

        async function showDebugModal() {
            document.getElementById('debug-modal').classList.add('visible');
            await loadDebugInfo();
        }

        function closeDebugModal() {
            document.getElementById('debug-modal').classList.remove('visible');
        }

        async function loadDebugInfo() {
            const debugBody = document.getElementById('debug-body');
            debugBody.innerHTML = '<div class="debug-status-item"><span class="message">Loading...</span></div>';

            try {
                const response = await fetch(`${API_BASE_URL}/ai-status`);
                const logs = await response.json();

                let html = '';
                logs.forEach(log => {
                    const time = new Date(log.created_at).toLocaleTimeString();
                    html += `
                        <div class="debug-status-item">
                            <span class="message">${log.message}</span>
                            <span class="time">${time}</span>
                        </div>
                    `;
                });

                html += `
                    <button class="debug-refresh" onclick="loadDebugInfo()">
                        <i class="fa-solid fa-refresh"></i> Refresh Status
                    </button>
                `;

                debugBody.innerHTML = html;
            } catch (error) {
                debugBody.innerHTML = `
                    <div class="debug-status-item">
                        <span class="message" style="color: var(--danger);">
                            Failed to load AI status: ${error.message}
                        </span>
                    </div>
                    <button class="debug-refresh" onclick="loadDebugInfo()">
                        <i class="fa-solid fa-refresh"></i> Retry
                    </button>
                `;
            }
        }

        function updatePathInfo() {
            const pathInfo = document.getElementById('path-info');
            const pathInfoDesc = pathInfo.querySelector('.path-info-desc');
            const pathInfoSalary = pathInfo.querySelector('.path-info-salary');

            const path = CAREER_PATHS[currentCareerPath];
            if (path && currentCareerPath !== 'all') {
                pathInfoDesc.textContent = path.desc;
                pathInfoSalary.textContent = `Average Salary: ${path.salary}`;
                pathInfo.classList.add('visible');
            } else {
                pathInfo.classList.remove('visible');
            }
        }

        // ========================================
        // LOAD CURRICULUM
        // ========================================
        async function loadCurriculum() {
            try {
                const response = await fetch(`${API_BASE_URL}/curriculum`);
                const data = await response.json();

                allTracks = data.tracks;
                allLessons = [];
                allTracks.forEach(track => {
                    track.lessons.forEach(lesson => {
                        allLessons.push({
                            ...lesson,
                            trackTitle: track.title
                        });
                    });
                });

                totalLessons = allLessons.length;
                calculateTrackProgress();
                renderSyllabus();
                updateSkillTree();

                const pendingCount = allLessons.filter(l => l.status === 'pending').length;
                pendingLessonsCount = pendingCount;
                document.getElementById('ai-progress').textContent =
                    `${totalLessons - pendingCount} / ${totalLessons}`;

                console.log('âœ… Curriculum loaded:', totalLessons, 'lessons');
            } catch (error) {
                console.error('âŒ Failed to load curriculum:', error);
            }
        }

        // ========================================
        // SKILL TREE PROGRESS
        // ========================================
        function calculateTrackProgress() {
            trackProgress = {};

            allTracks.forEach(track => {
                const totalInTrack = track.lessons.length;
                const viewedInTrack = track.lessons.filter(l => viewedLessons.includes(l.id)).length;

                trackProgress[track.id] = {
                    viewed: viewedInTrack,
                    total: totalInTrack,
                    percentage: totalInTrack > 0 ? Math.round((viewedInTrack / totalInTrack) * 100) : 0
                };
            });
        }

        function updateSkillTree() {
            calculateTrackProgress();

            // Update overall progress
            const viewed = viewedLessons.length;
            const total = totalLessons;
            const overallPercent = total > 0 ? Math.round((viewed / total) * 100) : 0;

            document.getElementById('overall-progress-fill').style.width = `${overallPercent}%`;
            document.getElementById('overall-stats').textContent = `${viewed} / ${total}`;

            if (viewed === 0) {
                document.getElementById('overall-progress-text').textContent = 'Get started by viewing your first lesson';
            } else if (viewed === total) {
                document.getElementById('overall-progress-text').textContent = 'ðŸŽ‰ All lessons completed! You\'re amazing!';
            } else {
                document.getElementById('overall-progress-text').textContent = `${overallPercent}% complete - Keep going!`;
            }

            // Filter tracks based on career path
            let tracksToShow = allTracks;
            const path = CAREER_PATHS[currentCareerPath];
            if (path && path.tracks.length > 0) {
                tracksToShow = allTracks.filter(track => path.tracks.includes(track.id));
            }

            // Update track-by-track progress
            const container = document.getElementById('skill-tree-tracks');
            container.innerHTML = '';

            tracksToShow.forEach(track => {
                const progress = trackProgress[track.id] || { viewed: 0, total: 0, percentage: 0 };

                const trackEl = document.createElement('div');
                trackEl.className = 'skill-tree-track';
                trackEl.innerHTML = `
                    <div class="skill-tree-track-header">
                        <div class="skill-tree-track-name">${track.title}</div>
                        <div class="skill-tree-track-progress">${progress.viewed}/${progress.total}</div>
                    </div>
                    <div class="skill-tree-track-bar">
                        <div class="skill-tree-track-fill" style="width: ${progress.percentage}%;"></div>
                    </div>
                `;
                container.appendChild(trackEl);
            });
        }

        function toggleSkillTree() {
            const body = document.getElementById('skill-tree-body');
            const icon = document.getElementById('skill-tree-icon');

            body.classList.toggle('collapsed');

            if (body.classList.contains('collapsed')) {
                icon.style.transform = 'rotate(-90deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // ========================================
        // RENDER SYLLABUS
        // ========================================
        function renderSyllabus() {
            const container = document.getElementById('lesson-list');

            // Check if we already have content to avoid full re-render flickering
            const existingTracks = container.children.length > 0;
            if (existingTracks) {
                // Just update badges if needed, or clear if you want full re-render
                container.innerHTML = '';
            }

            allTracks.forEach(track => {
                const progress = trackProgress[track.id] || { viewed: 0, total: 0 };

                const trackEl = document.createElement('div');
                trackEl.className = 'lesson-track';
                trackEl.dataset.trackId = track.id;

                const headerEl = document.createElement('div');
                headerEl.className = 'track-header';
                headerEl.innerHTML = `
                    <div class="track-title-container">
                        <span class="track-title">${track.title}</span>
                        <span class="track-progress-badge">${progress.viewed}/${progress.total}</span>
                    </div>
                    <i class="fa-solid fa-chevron-down track-icon"></i>
                `;

                // Toggle Logic
                headerEl.addEventListener('click', () => {
                    headerEl.classList.toggle('expanded');
                    itemsEl.classList.toggle('expanded');
                });

                const itemsEl = document.createElement('div');
                itemsEl.className = 'lesson-items';

                track.lessons.forEach(lesson => {
                    const lessonEl = document.createElement('div');
                    lessonEl.className = 'lesson-item';
                    lessonEl.dataset.lessonId = lesson.id;

                    const isViewed = viewedLessons.includes(lesson.id);
                    if (isViewed) {
                        lessonEl.classList.add('viewed');
                    }

                    const isGenerating = lesson.status === 'pending';
                    if (isGenerating) {
                        lessonEl.classList.add('generating');
                    }

                    let icon = 'ðŸ“„';
                    if (lesson.type === 'lab') icon = 'ðŸ§ª';
                    else if (lesson.type === 'challenge') icon = 'ðŸ†';
                    else if (lesson.type === 'project') icon = 'ðŸš€';

                    lessonEl.innerHTML = `
                        <div class="lesson-icon">
                            ${isViewed ? '<i class="fa-solid fa-check"></i>' : icon}
                        </div>
                        <div class="lesson-details">
                            <div class="lesson-title">${lesson.title}</div>
                            <div class="lesson-meta">
                                <span>${lesson.duration || '15 min'}</span>
                                <span>â€¢</span>
                                <span>${isGenerating ? 'Generating...' : lesson.type || 'concept'}</span>
                            </div>
                        </div>
                    `;

                    if (!isGenerating) {
                        lessonEl.addEventListener('click', () => loadLesson(lesson.id));
                    }

                    itemsEl.appendChild(lessonEl);
                });

                trackEl.appendChild(headerEl);
                trackEl.appendChild(itemsEl);
                container.appendChild(trackEl);
            });

            // Expand the first track by default only on initial load
            if (!existingTracks) {
                const firstHeader = container.querySelector('.track-header');
                const firstItems = container.querySelector('.lesson-items');
                if (firstHeader && firstItems) {
                    firstHeader.classList.add('expanded');
                    firstItems.classList.add('expanded');
                }
            }

            filterByCareerPath();
        }

        // ========================================
        // LOAD LESSON
        // ========================================
        async function loadLesson(lessonId) {
            try {
                const response = await fetch(`${API_BASE_URL}/lesson/${lessonId}`);
                const lesson = await response.json();

                if (lesson.error) {
                    console.error('Lesson not found:', lessonId);
                    return;
                }

                currentLesson = lesson;
                currentIndex = allLessons.findIndex(l => l.id === lessonId);

                // Auto-mark as viewed
                if (!viewedLessons.includes(lessonId)) {
                    viewedLessons.push(lessonId);
                    localStorage.setItem('devquest_viewed', JSON.stringify(viewedLessons));
                    updateSkillTree();
                    // NOTE: Removed renderSyllabus here to prevent sidebar reset!
                    // Instead, update just the visual state of the lesson item
                    const lessonEl = document.querySelector(`[data-lesson-id="${lessonId}"]`);
                    if (lessonEl) {
                        lessonEl.classList.add('viewed');
                        const icon = lessonEl.querySelector('.lesson-icon');
                        icon.innerHTML = '<i class="fa-solid fa-check"></i>';
                    }
                    showToast('Progress saved!');
                }

                document.getElementById('lesson-title').textContent = lesson.title;
                document.getElementById('lesson-type').textContent = lesson.lesson_type || 'concept';
                document.getElementById('lesson-duration').textContent = '15 min';

                const analogySection = document.getElementById('analogy-section');
                const analogyText = document.getElementById('analogy-text');
                if (lesson.analogy) {
                    analogyText.textContent = lesson.analogy;
                    analogySection.style.display = 'block';
                } else {
                    analogySection.style.display = 'none';
                }

                const markdown = marked.parse(lesson.content || lesson.content_markdown || '# Loading...');
                document.getElementById('markdown-content').innerHTML = markdown;

                const code = lesson.starter_code || '# No starter code provided';
                originalCode = code;
                editor.setValue(code, -1);

                const mode = lesson.ide_mode || 'python';
                editor.session.setMode(`ace/mode/${mode}`);

                document.getElementById('console').innerHTML = '';

                // --- UI FIX: Highlight Active & Keep Sidebar Open ---
                document.querySelectorAll('.lesson-item').forEach(el => {
                    el.classList.remove('active');
                });

                const activeLesson = document.querySelector(`[data-lesson-id="${lessonId}"]`);
                if (activeLesson) {
                    activeLesson.classList.add('active');

                    // Force Sidebar Track Open
                    const trackEl = activeLesson.closest('.lesson-track');
                    if (trackEl) {
                        const header = trackEl.querySelector('.track-header');
                        const items = trackEl.querySelector('.lesson-items');

                        // Add class if missing
                        if (header && !header.classList.contains('expanded')) {
                            header.classList.add('expanded');
                        }
                        if (items && !items.classList.contains('expanded')) {
                            items.classList.add('expanded');
                        }
                    }

                    // Scroll to it
                    activeLesson.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }

                updateNavButtons();
                updateLessonPosition();

                console.log('ðŸ“– Loaded lesson:', lesson.title);
            } catch (error) {
                console.error('Failed to load lesson:', error);
            }
        }

        function updateLessonPosition() {
            if (currentIndex >= 0 && totalLessons > 0) {
                document.getElementById('current-pos').textContent = currentIndex + 1;
                document.getElementById('total-pos').textContent = totalLessons;
            } else {
                document.getElementById('current-pos').textContent = '-';
                document.getElementById('total-pos').textContent = '-';
            }
        }

        // ========================================
        // FILTERING
        // ========================================
        function filterByCareerPath() {
            const path = CAREER_PATHS[currentCareerPath];
            if (!path || currentCareerPath === 'all') {
                document.querySelectorAll('.lesson-track').forEach(el => {
                    el.classList.remove('hidden');
                });
                return;
            }

            document.querySelectorAll('.lesson-track').forEach(trackEl => {
                const trackId = trackEl.dataset.trackId;
                const shouldShow = path.tracks.includes(trackId);
                trackEl.classList.toggle('hidden', !shouldShow);
            });
        }

        function filterLessons(searchQuery) {
            const container = document.getElementById('lesson-list');
            let visibleLessonCount = 0;

            allTracks.forEach(track => {
                const trackEl = container.querySelector(`[data-track-id="${track.id}"]`);
                if (!trackEl) {
                    return;
                }

                let visibleLessonsInTrack = 0;

                track.lessons.forEach(lesson => {
                    const lessonEl = trackEl.querySelector(`[data-lesson-id="${lesson.id}"]`);
                    if (!lessonEl) return;

                    const matchesSearch = !searchQuery ||
                                        lesson.title.toLowerCase().includes(searchQuery) ||
                                        track.title.toLowerCase().includes(searchQuery);

                    if (matchesSearch) {
                        lessonEl.classList.remove('hidden');
                        lessonEl.classList.toggle('search-highlight', searchQuery &&
                            lesson.title.toLowerCase().includes(searchQuery));
                        visibleLessonsInTrack++;
                        visibleLessonCount++;
                    } else {
                        lessonEl.classList.add('hidden');
                        lessonEl.classList.remove('search-highlight');
                    }
                });

                trackEl.classList.toggle('hidden', visibleLessonsInTrack === 0);
            });

            const existingNoResults = container.querySelector('.no-results');
            if (existingNoResults) existingNoResults.remove();

            if (visibleLessonCount === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'no-results';
                noResults.innerHTML = `
                    <i class="fa-solid fa-search"></i>
                    <p>No lessons found matching "${searchQuery || 'your criteria'}"</p>
                    <p style="margin-top: 8px; font-size: 12px;">Try a different search term or career path</p>
                `;
                container.appendChild(noResults);
            }
        }

        function loadSavedPreferences() {
            const savedPath = localStorage.getItem('devquest_career_path');
            if (savedPath && CAREER_PATHS[savedPath]) {
                document.getElementById('career-path-select').value = savedPath;
                currentCareerPath = savedPath;
                filterByCareerPath();
            }
        }

        // ========================================
        // NAVIGATION
        // ========================================
        function updateNavButtons() {
            document.getElementById('prev-btn').disabled = currentIndex <= 0;
            document.getElementById('next-btn').disabled = currentIndex < 0 || currentIndex >= allLessons.length - 1;
        }

        function prevLesson() {
            if (currentIndex > 0) {
                loadLesson(allLessons[currentIndex - 1].id);
            }
        }

        function nextLesson() {
            if (currentIndex >= 0 && currentIndex < allLessons.length - 1) {
                loadLesson(allLessons[currentIndex + 1].id);
            }
        }

        // ========================================
        // CODE EXECUTION
        // ========================================
        async function initPyodide() {
            try {
                pyodide = await loadPyodide();
                console.log('âœ… Pyodide loaded successfully');
            } catch (error) {
                console.error('âŒ Failed to load Pyodide:', error);
            }
        }

        async function runCode() {
            const code = editor.getValue();
            const consoleEl = document.getElementById('console');
            consoleEl.innerHTML = '<span style="color: #888">Running...</span>';

            const lang = currentLesson?.ide_mode || 'python';

            if (lang === 'python') {
                if (!pyodide) {
                    consoleEl.innerHTML = '<span style="color: #f59e0b">â³ Python is still loading...</span>';
                    return;
                }

                try {
                    let output = [];
                    pyodide.setStdout({ batched: (text) => output.push(text) });
                    pyodide.setStderr({ batched: (text) => output.push(`<span style="color:#ef4444">${text}</span>`) });

                    await pyodide.runPythonAsync(code);

                    consoleEl.innerHTML = output.join('\n') || '<span style="color: #888">No output</span>';
                } catch (e) {
                    consoleEl.innerHTML = `<span style="color: #ef4444">${escapeHtml(e.toString())}</span>`;
                }
            } else if (lang === 'javascript') {
                try {
                    const logs = [];
                    const originalLog = console.log;
                    const originalError = console.error;

                    console.log = (...args) => logs.push(args.map(String).join(' '));
                    console.error = (...args) => logs.push(`<span style="color:#ef4444">${args.map(String).join(' ')}</span>`);

                    eval(code);

                    console.log = originalLog;
                    console.error = originalError;

                    consoleEl.innerHTML = logs.join('\n') || '<span style="color: #888">No output</span>';
                } catch (e) {
                    consoleEl.innerHTML = `<span style="color: #ef4444">${escapeHtml(e.toString())}</span>`;
                }
            } else {
                consoleEl.innerHTML = `<span style="color: #f59e0b">ðŸ’¡ ${lang.toUpperCase()} - Copy this code and run it in your terminal or IDE</span>`;
            }
        }

        function resetCode() {
            editor.setValue(originalCode, -1);
            document.getElementById('console').innerHTML = '';
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        // ========================================
        // PROGRESS SYSTEM
        // ========================================
        function loadProgress() {
            const savedViewed = localStorage.getItem('devquest_viewed');

            if (savedViewed) {
                viewedLessons = JSON.parse(savedViewed);
            }
        }

        // ========================================
        // TOAST
        // ========================================
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;

            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 2000);
        }

        // ========================================
        // UTILITY
        // ========================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // START
        // ========================================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>